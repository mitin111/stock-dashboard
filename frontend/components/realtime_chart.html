<script>
let history    = window.initialHistory || [];
let wsUrl      = window.wsUrl || "wss://backend-stream-nmlf.onrender.com/ws/live";
let initialTok = window.initialToken || null;   // Example token: NSE|21614
let barIntMin  = Number(window.barInterval || 1);

const chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
  layout: { background:{color:"#000"}, textColor:"#fff" },
  grid: { vertLines:{color:"#222"}, horzLines:{color:"#222"} },
  timeScale: { timeVisible:true, secondsVisible:false, rightOffset:3 }
});

// ✅ Force India Timezone
chart.applyOptions({
  timezone: 'Asia/Kolkata',
  localization: {
    locale: 'en-IN',
    timeFormatter: t => new Date(t*1000).toLocaleString('en-IN', {
      timeZone:'Asia/Kolkata', hour12:false
    })
  },
  timeScale: {
    tickMarkFormatter: (time) => new Date(time*1000).toLocaleTimeString('en-IN', {
      timeZone:'Asia/Kolkata', hour12:false, hour:'2-digit', minute:'2-digit'
    })
  }
});

const candleSeries = chart.addCandlestickSeries({
  upColor:"#26a69a", downColor:"#ef5350",
  borderUpColor:"#26a69a", borderDownColor:"#ef5350",
  wickUpColor:"#26a69a", wickDownColor:"#ef5350"
});

candleSeries.setData(history);

// Time bucket
function bucket(ts){
  const d = new Date(ts * 1000);
  d.setSeconds(0,0);
  d.setMinutes(Math.floor(d.getMinutes()/barIntMin)*barIntMin);
  return Math.floor(d.getTime()/1000);
}

// Candle state
let last = history.length ? { ...history[history.length - 1] } : null;

// ✅ WebSocket global
let ws;

async function httpSubscribe(){
  await fetch(wsUrl.replace("/ws/live","/subscribe"), {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ tokens:[initialTok] })
  }).catch(()=>{});
}

function connect(){
  ws = new WebSocket(wsUrl);

  ws.onopen = async () => {
    console.log("✅ WS Connected:", wsUrl);
    await httpSubscribe();
  };

  ws.onerror = (err) => {
    console.log("❌ WS Error:", err);
  };

  ws.onclose = () => {
    console.log("⚠️ WS Closed — reconnecting...");
    setTimeout(connect, 1500);
  };

  ws.onmessage = (ev) => {
    try {
      const p = JSON.parse(ev.data);

      const price = Number(p.lp ?? p.ltp ?? p.price ?? p.close);
      let ts = Number(p.ft ?? p.time ?? p.lts ?? p.timestamp);
      if(!price || !ts) return;

      if(ts > 1e12) ts = Math.floor(ts / 1000);

      const b = bucket(ts);

      if(!last || b > last.time){
        last = { time:b, open:price, high:price, low:price, close:price };
      } else {
        last.high = Math.max(last.high, price);
        last.low  = Math.min(last.low, price);
        last.close = price;
      }

      candleSeries.update(last);
    } catch(e){}
  };
}

function start(){
  if(initialTok) connect();
  else setTimeout(start, 800);
}

start();
</script>

