<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin: 0;
  background: #000;
  overflow: hidden;
}
#chart-container {
  width: 100%;
  height: 100vh;
}
</style>
</head>

<body>
<div id="chart-container"></div>

<script>
// ---- REQUIRED INPUT FROM PYTHON ----
let history = window.initialHistory || [];  // injected by Streamlit
let wsUrl;

// auto detect fallback
if (!window.wsUrl) {
  wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + "/ws/live";
} else {
  wsUrl = window.wsUrl;
}

// ---- CREATE CHART ----
const chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
  layout: { background: { color: '#000' }, textColor: '#fff' },
  grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
  timeScale: { timeVisible: true, secondsVisible: false, rightOffset: 3 },
  crosshair: { mode: 1 },
});
const candleSeries = chart.addCandlestickSeries({
  upColor: '#26a69a', downColor: '#ef5350', borderUpColor: '#26a69a', borderDownColor: '#ef5350',
  wickUpColor: '#26a69a', wickDownColor: '#ef5350'
});

// load initial candles
candleSeries.setData(history);

// ---- OPEN WEBSOCKET ----
let ws = new WebSocket(wsUrl);

ws.onopen = () => console.log("âœ… Lightweight WS Connected:", wsUrl);

ws.onmessage = (event) => {
  try {
    let msg = JSON.parse(event.data);
    if (!msg || !msg.lp || !msg.tk) return;

    const ts = Number(msg.ft || msg.time) * 1000;
    const price = Number(msg.lp);

    if (!ts || !price) return;

    // candle minute grouping
    const dt = new Date(ts);
    dt.setSeconds(0, 0);
    const t = Math.floor(dt.getTime() / 1000);

    candleSeries.update({
      time: t,
      open: price,
      high: price,
      low: price,
      close: price
    });

  } catch (e) {
    console.log("âš ï¸ Tick parse error:", e);
  }
};

ws.onclose = () => {
  console.log("ðŸ”Œ WS Closed â€” Reconnecting in 2s...");
  setTimeout(() => location.reload(), 2000);
};
</script>
</body>
</html>

